# 38 | 架构师应该如何判断技术演进的方向？

面对层出不穷的新技术，我们应该采取什么样的策略？

1. 潮流派

潮流派的典型特征就是对于新技术特别热衷，紧跟技术潮流，当有新的技术出现时，迫切想将新的技术应用到自己的产品中。

首先，新技术需要时间成熟，如果刚出来就用，此时新技术还不怎么成熟，实际应用中很可能遇到各种“坑”，自己成了实验小白鼠。

其次，新技术需要学习，需要花费一定的时间去掌握，这个也是较大的成本；如果等到掌握了技术后又发现不适用，则是一种较大的人力浪费。

2. 保守派

对于新技术抱有很强的戒备心，稳定压倒一切，已经掌握了某种技术，就一直用这种技术打天下。

保守派的主要问题是不能享受新技术带来的收益，例如有了拖拉机，你还偏偏要用牛车。

3. 跟风派

跟着竞争对手的步子走。简单来说，判断技术的发展就看竞争对手，竞争对手用了咱们就用，竞争对手没用咱们就等等看。

跟风派最大的问题在于如果没有风可跟的时候怎么办。即使有风可跟，有时候适用于竞争对手的技术，并不一定适用于自己，盲目模仿可能带来相反的效果。另外，竞争对手的这些信息并不那么容易获取。

既然潮流派、保守派、跟风派都存在这样或者那样的问题，那架构师究竟如何判断技术演进的方向呢？

**技术演进的动力**

归根到底就是业务的发展。影响一个企业业务的发展主要有 3 个因素：市场、技术、管理，这三者构成支撑业务发展的铁三角，任何一个因素的不足，都可能导致企业的业务停滞不前。

<img src="https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210208215828.png" alt="image-20210208215828707" style="zoom: 50%;" />

我们可以简单地将企业的业务分为两类：一类是产品类，一类是服务类。

- 对于产品类业务，技术创新推动业务发展

用户选择一个产品的根本驱动力在于产品的功能是否能够更好地帮助自己完成任务。用户会自然而然地选择那些功能更加强大、性能更加先进、体验更加顺畅、外观更加漂亮的产品，而功能、性能、体验、外观等都需要强大的技术支撑。例如，iPhone 手机的多点触摸操作、UC 浏览器的 U3 内核等。

- 对于“服务”类的业务，业务发展推动技术的发展

用户选择一个产品的根本驱动力是其“功能”，而用户选择一个服务的根本驱动力不是功能，而是“规模”。例如，选择 UC 浏览器还是选择 QQ 浏览器，更多的人是根据个人喜好和体验来决定的；而选择微信还是 Whatsapp，是根据其规模来选择的。

服务类的业务发展路径是这样的：提出一种创新的服务模式→吸引了一批用户→业务开始发展→吸引了更多用户→服务模式不断完善和创新→吸引越来越多的用户，如此循环往复。

在这个发展路径中，技术并没有成为业务发展的驱动力，反过来由于用户规模的不断扩展，业务的不断创新和改进，对技术会提出越来越高的要求，因此是业务驱动了技术发展。

其实回到产品类业务，如果我们将观察的时间拉长来看，即使是产品类业务，在技术创新开创了一个新的业务后，后续的业务发展也会反向推动技术的发展。例如，第一代 iPhone 缺少对 3G 的支持，且只能通过 Web 发布应用程序，第二代 iPhone 才开始支持 3G，并且内置 GPS。

综合这些分析，除非是开创新的技术能够推动或者创造一种新的业务，其他情况下，都是业务的发展推动了技术的发展。

# 39 | 互联网技术演进的模式

以互联网的业务发展为案例，谈谈互联网技术演进的模式，其他行业可以参考分析方法对自己的行业进行分析。

互联网业务发展一般分为几个时期：初创期、发展期、竞争期、成熟期。不同时期的差别主要体现在两个方面：复杂性、用户规模。

**业务复杂性**

1. 初创期

互联网业务刚开始一般都是一个创新的业务点，这个业务点的重点不在于“完善”，而在于“创新”，只有创新才能吸引用户。

初创期的业务对技术就一个要求：“快”。

2. 发展期

当业务推出后经过市场验证如果是可行的，则吸引的用户就会越来越多，此时原来不完善的业务就进入了一个快速发展的时期。

这个阶段技术的核心工作是快速地实现各种需求。如何做到“快”，一般会经历下面几个阶段。

- 堆功能期

  业务进入快速发展期的初期，此时团队规模也不大，业务需求又很紧，最快实现业务需求的方式是继续在原有的系统里面不断地增加新的功能。

- 优化期

  随着功能越来越多，系统开始变得越来越复杂，后面继续堆功能会感到越来越吃力，速度越来越慢。

  如何解决这个问题，一般会分为两派：一派是优化派，一派是架构派。

- 架构期

  如果业务能够继续发展，慢慢就会发现优化也顶不住了，毕竟再怎么优化，系统的能力总是有极限的。

3. 竞争期

当业务继续发展，已经形成一定规模后，一定会有竞争对手开始加入行业来竞争。新业务的创新给技术带来的典型压力就是新的系统会更多，系统数量的量变带来了技术工作的质变。主要体现在下面几个方面：

- 重复造轮子

  系统越来越多，各系统相似的工作越来越多。

- 系统交互一团乱麻

  系统越来越多，各系统的交互关系变成了网状。

针对这个时期业务变化带来的问题，技术工作主要的解决手段有：

- 平台化

  目的在于解决“重复造轮子”的问题。

- 服务化

  目的在于解决“系统交互”的问题，常见的做法是通过消息队列来完成系统间的异步通知，通过服务框架来完成系统间的同步调用。

4. 成熟期

当企业熬过竞争期，成为了行业的领头羊，此时求快求新已经没有很大空间，业务上开始转向为“求精”。

**用户规模**

互联网业务的发展会经历“初创期、发展期、竞争期、成熟期”几个阶段，不同阶段典型的差别就是用户量的差别，用户量随着业务的发展而越来越大。

用户量增大对技术的影响主要体现在两个方面：性能要求越来越高、可用性要求越来越高。

1. 性能

用户量增大，性能要求也越高。以 MySQL 为例，单台 MySQL 机器支撑的 TPS 和 QPS 最高也就是万级，必然要考虑使用多台 MySQL。

2. 可用性

1 万用户宕机 1 小时，你可能才损失了几千元；100 万用户宕机 10 分钟，损失可能就是几十万元了。

**量变到质变**

互联网业务驱动技术发展的两大主要因素是复杂性和用户规模，这两个因素的本质其实都是“量变带来质变”。

![image-20210209223846189](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210209223846.png)

# 40 | 互联网架构模板：“存储层”技术

互联网的标准技术架构如下图所示。

<img src="https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210211075224.png" alt="image-20210211075224419" style="zoom:50%;" />

> 这张图基本上涵盖了互联网技术公司的大部分技术点，不同的公司只是在具体的技术实现上稍有差异，但不会跳出这个框架的范畴

从本期开始，我将逐层介绍每个技术点的产生背景、应用场景、关键技术。今天我们首先来聊聊互联网架构模板的“存储层”技术。

**SQL**

随着互联网业务的发展，性能要求越来越高，必然要面对一个问题：将数据拆分到多个数据库实例才能满足业务的性能需求。

数据库拆分满足了性能的要求，但带来了复杂度的问题：数据如何拆分、数据如何组合？这个复杂度的问题解决起来并不容易，如果每个业务都去实现一遍，重复造轮子将导致投入浪费、效率降低，业务开发想快都快不起来。

所以互联网公司流行的做法是业务发展到一定阶段后，就会将这部分功能独立成中间件。

如果公司业务继续发展，规模继续扩大，SQL 服务器越来越多，实力雄厚的大公司此时一般都会在 SQL 集群上构建 SQL 存储平台，以对业务透明的形式提供资源分配、数据备份、迁移、容灾、读写分离、分库分表等一系列服务。

**NoSQL**

如果公司发展很快，例如 Memcache 的节点有上千甚至几千时，通常都会在 NoSQL 集群的基础之上再实现统一存储平台，统一存储平台主要实现这几个功能：

- 资源按需动态分配：例如同一台 Memcache 服务器，可以根据内存利用率，分配给多个业务使用。
- 资源自动化管理：例如新业务只需要申请多少 Memcache 缓存空间就可以了，无需关注具体是哪些 Memcache 服务器在为自己提供服务。
- 故障自动化处理：例如某台 Memcache 服务器挂掉后，有另外一台备份 Memcache 服务器能立刻接管缓存请求，不会导致丢失很多缓存数据。

**小文件存储**

除了关系型的业务数据，互联网行业还有很多用于展示的数据。例如，淘宝的商品图片。这些数据具有三个典型特征：

一是数据小，一般在 1MB 以下；

二是数量巨大，Facebook 在 2013 年每天上传的照片就达到了 3.5 亿张；

三是访问量巨大，Facebook 每天的访问量超过 10 亿。

得益于开源运动的发展和最近几年大数据的火爆，HBase、Hadoop、Hypertable、FastDFS 等都可以作为小文件存储的底层平台。只需要将这些开源方案再包装一下基本上就可以用了。

典型的小文件存储有：淘宝的 TFS、京东 JFS、Facebook 的 Haystack。下图是淘宝 TFS 的架构：

![image-20210211080852748](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210211080852.png)

**大文件存储**

互联网行业的大文件主要分为两类：一类是业务上的大数据，例如 Youtube 的视频；另一类是海量的日志数据，例如各种访问日志。

说到大文件，特别要提到 Google 和 Yahoo，Google 的 3 篇大数据论文（Bigtable/Map- Reduce/GFS）开启了一个大数据的时代，而 Yahoo 开源的 Hadoop 系列（HDFS、HBase 等），基本上垄断了开源界的大数据处理。

下面是 Hadoop 的生态圈：

![image-20210211075037106](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210211075037.png)

**思考题**

既然存储技术发展到最后都是存储平台，为何没有出现存储平台的开源方案，但云计算却都提供了存储平台方案？

# 41 | 互联网架构模板：“开发层”和“服务层”技术

今天我们来聊聊互联网架构模板的“开发层”和“服务层”技术。

**开发层技术**

1. 开发框架

互联网公司都会指定一个大的技术方向，然后使用统一的开发框架。例如，Java 相关的开发框架 SSH、SpringMVC、Play，Ruby 的 Ruby on Rails，PHP 的 ThinkPHP，Python 的 Django 等。

对于框架的选择，有一个总的原则：优选成熟的框架，避免盲目追逐新技术！

2. Web 服务器

开发框架只是负责完成业务功能的开发，真正能够运行起来给用户提供服务，还需要服务器配合。

选择一个服务器主要和开发语言相关，例如，Java 的有 Tomcat、JBoss、Resin 等，PHP/Python 的用 Nginx，当然最保险的就是用 Apache 了，什么语言都支持。

3. 容器

传统的虚拟化技术是虚拟机，解决了跨平台的问题，但由于虚拟机太庞大，启动又慢，运行时太占资源，在互联网行业并没有大规模应用。

Docker 的容器技术，将在很大程度上改变目前的技术形势：

- 运维方式会发生革命性的变化：Docker 启动快，几乎不占资源，随时启动和停止，基于 Docker 打造自动化运维、智能化运维将成为主流方式。
- 设计模式会发生本质上的变化：启动一个新的容器实例代价如此低，将鼓励设计思路朝“微服务”的方向发展。

**服务层技术**

服务层的主要目标其实就是为了降低系统间相互关联的复杂度。

1. 配置中心

将配置中心做成通用的系统的好处有：

- 集中配置多个系统，操作效率高。所有配置都在一个集中的地方，检查方便，协作效率高。
- 配置中心可以实现程序化的规则检查，避免常见的错误。比如说检查最小值、最大值、是否 IP 地址、是否 URL 地址，都可以用正则表达式完成。
- 配置中心相当于备份了系统的配置，当某些情况下需要搭建新的环境时，能够快速搭建环境和恢复业务。

下面是配置中心简单的设计，其中通过“系统标识 + host + port”来标识唯一一个系统运行实例是常见的设计方法。

<img src="https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210213184508.png" alt="image-20210213184508579" style="zoom:50%;" />

2. 服务中心

当系统数量不多的时候，系统间的调用一般都是直接通过配置文件记录在各系统内部的，但当系统数量多了以后，这种方式就存在问题了。

比如说总共有 10 个系统依赖 A 系统的 X 接口，A 系统实现了一个新接口 Y，能够更好地提供原有 X 接口的功能，如果要让已有的 10 个系统都切换到 Y 接口，则这 10 个系统的几十上百台机器的配置都要修改，然后重启，可想而知这个效率是很低的。

除此以外，如果 A 系统总共有 20 台机器，现在其中 5 台出故障了，其他系统如果是通过域名访问 A 系统，则域名缓存失效前，还是可能访问到这 5 台故障机器的。

如果其他系统通过 IP 访问 A 系统，那么 A 系统每次增加或者删除机器，其他所有 10 个系统的几十上百台机器都要同步修改，这样的协调工作量也是非常大的。

服务中心就是为了解决上面提到的跨系统依赖的“配置”和“调度”问题。一般来说有两种实现方式：服务名字系统和服务总线系统。

- 服务名字系统（Service Name System）

服务名字系统跟 DNS 性质基本是类似的。服务名字系统是为了将 Service 名称解析为“host + port + 接口名称”，但是和 DNS 一样，真正发起请求的还是请求方。

基本的设计如下：

![image-20210213204704102](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210213204916.png)

- 服务总线系统（Service Bus System）

服务总线系统跟计算机总线本质也是基本类似的。相比服务名字系统，服务总线系统更进一步了：由总线系统完成调用，服务请求方都不需要直接和服务提供方交互了。

基本的设计如下：

![image-20210213205035362](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210213205035.png)

“服务名字系统”和“服务总线系统”简单对比如下表所示。

![image-20210213205109188](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210213205207.png)

3. 消息队列

互联网业务的一个特点是“快”，这就要求很多业务处理采用异步的方式。例如，大 V 发布一条微博后，系统需要发消息给关注的用户，我们不可能等到所有消息都发送给关注用户后再告诉大 V 说微博发布成功了，只能先让大 V 发布微博，然后再发消息给关注用户。

传统的异步通知方式是由消息生产者直接调用消息消费者提供的接口进行通知的，但当业务变得庞大，子系统数量增多时，这样做会导致系统间交互非常复杂和难以管理，因为系统间互相依赖和调用，整个系统的结构就像一张蜘蛛网，如下图所示。

![image-20210213205415948](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210213205431.png)

消息队列就是为了实现这种跨系统异步通知的中间件系统。消息队列既可以“一对一”通知，也可以“一对多”广播。以微博为例，可以清晰地看到异步通知的实现和作用，如下图所示。

![image-20210213205431733](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210213205431.png)

# 42 | 互联网架构模板：“网络层”技术

























