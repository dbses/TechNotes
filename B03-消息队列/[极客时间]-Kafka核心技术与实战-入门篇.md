> 来源：极客时间《Kafka核心技术与实战》

# 开篇词

**为什么要学习 Kafka?**

日常工作中，如何应对数据量激增、数据复杂度增加以及数据变化速率变化问题？

对于数据量激增来说，Kafka 能够有效隔离上下游业务，将上游突增的流量缓存起来，以平滑的方式传导到下游子系统中。

学习 Kafka 也涉及到其他技术，比如：消息引擎应用、应用程序集成、分布式存储构建、流处理应用的开发与部署。

**如何学习 Kafka?**

第一步：掌握 Kafka 客户端，去官网学习代码示例。

第二步：学习 Kafka 的高级功能，比如流处理应用开发。

**专栏的组成**

![image-20210423230528744](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210423230528.png)

第一部分：消息引擎这类系统原理和用途；

第二部分：Kafka 如何用于生产环境；

第三部分：学习 Kafka 客户端；

第四部分：Kafka 核心设计原理；

第五部分：Kafka 运维与监控；

第六部分：Kafka 流处理组件 Kafka Streams 实战应用；

# 01 | Kafka 介绍

**Kafka 是什么？**

Apache Kafka 是一款开源的消息引擎系统 Messaging System，就像引擎一样，具备某种能量转换传输的能力。

**Kafka 是做什么用的？**

根据维基百科的定义，消息引擎系统是一组规范。企业利用这组规范在不同系统之间传递语义准确的消息，实现松耦合的异步式数据传递。

通俗来讲，就是系统 A 发送消息给消息引擎系统，系统 B 从消息引擎系统中读取 A 发送的消息。

**如何设计消息的传输格式？**

Kafka 使用的是纯二进制的字节序列。消息还是结构化的，只是在使用之前都要将其转换成二进制的字节序列。

**怎么把消息传输出去？**

常见的有两种方法：

- 点对点模型：系统 A 发送的消息只能被系统 B 接收，其他任何系统都不能读取 A 发送的消息。
- 发布 / 订阅模型：它有一个主题（Topic）的概念，你可以理解成逻辑语义相近的消息容器。发送方称为发布者（Publisher），接收方称为订阅者（Subscriber）。和点对点模型不同的是，这个模型可能存在多个发布者向相同的主题发送消息，而订阅者也可能存在多个，它们都能接收到相同主题的消息。生活中的报纸订阅就是一种典型的发布 / 订阅模型。

**为什么不直接发送而要通过消息引擎发送消息？**

削峰填谷、解耦、异步。这就是 Kafka 这类消息引擎系统的最大意义所在。

以上游的订单系统为例，Kafka 能够将瞬时增加的订单流量全部以消息形式保存在对应的主题中，既不影响上游服务的 TPS，同时也给下游子服务留出了充足的时间去消费它们。

这就是 Kafka 这类消息引擎系统的最大意义所在。

# 02 | Kafka 术语

- 消息：Record。Kafka 是消息引擎嘛，这里的消息就是指 Kafka 处理的主要对象。
- 主题：Topic。主题是承载消息的逻辑容器，在实际使用中多用来区分具体的业务。
- Broker：Kafka 集群由多个 Broker 组成，Broker 负责接收和处理客户端发送过来的请求，以及对消息进行持久化。
- Replication：即备份机制。把相同的数据拷贝到多台机器上，这些相同的数据称为副本（Replica）;
- Replica：即副本。Kafka 中同一条消息能够被拷贝到多个地方以提供数据冗余，这些地方就是所谓的副本。副本还分为领导者副本和追随者副本，各自有不同的角色划分。副本是在分区层级下的，即每个分区可配置多个副本实现高可用。
- Partition。即分区。分区是指一个有序不变的消息序列，每个主题下可以有多个分区。生产者生产的每条消息只会被发送到一个分区中。
- 消息位移：Offset。表示分区中每条消息的位置信息，是一个单调递增且不变的值。
- 生产者：Producer。向主题发布新消息的应用程序。
- 消费者：Consumer。从主题订阅新消息的应用程序。
- 消费者位移：Consumer Offset。表征消费者消费进度，每个消费者都有自己的消费者位移。
- 消费者组：Consumer Group。多个消费者实例共同组成的一个组，同时消费多个分区以实现高吞吐。
- 重平衡：Rebalance。消费者组内某个消费者实例挂掉后，其他消费者实例自动重新分配订阅主题分区的过程。Rebalance 是 Kafka 消费者端实现高可用的重要手段。
- 消息日志：Log。Kafka 使用消息日志（Log）来保存数据，一个日志就是磁盘上一个只能追加写（Append-only）消息的物理文件。
- 日志段：Log Segment。Kafka 要定期地删除消息以回收磁盘。怎么删除呢？简单来说就是通过日志段（Log Segment）机制。

这些概念可以用一张图来展示。

![image-20201122001949780](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20201122001949.png)

**Kafka实现高可用的手段**

1. Broker：一台Broker挂掉后，其他机器上的Broker也能对外提供服务；

2. Replication：Kafka 定义了两类副本，领导者副本（Leader Replica）和追随者副本（Follower Replica）。前者对外提供服务，这里的对外指的是与客户端程序进行交互；而后者只是被动地追随领导者副本而已，不能与外界进行交互。

   生产者总是向领导者副本写消息；而消费者总是从领导者副本读消息。至于追随者副本，它只做一件事：向领导者副本发送请求，请求领导者把最新生产的消息发给它，这样它能保持与领导者的同步。

   有了副本机制可以保证数据的持久化或消息不丢失。

# 03 | Kafka 只是消息引擎系统吗？

**了解一个系统或框架的前世今生有必要吗？**

不论是学习哪种技术，直接扎到具体的细节中，亦或是从一个很小的点开始学习，你很快就会感到厌烦。

因为你无法建立全局的认知观，不能实现系统地学习。

**Kafka 名字的由来**

因为 Kafka 系统的写性能很强，所以找了个作家的名字来命名，Jay Kreps（Kafka 作者之一）大学期间上了很多文学课，非常喜欢 Franz Kafka 这个作家。

**Kafka 的诞生**

Kafka 是 LinkedIn 公司内部孵化的项目。LinkedIn 最开始有强烈的数据强实时处理方面的需求。当时他们碰到的主要总是包括以下两点。

- 数据正确性不足

  因为数据的收集主要采用轮询（Polling）的方式，如何确定轮询的间隔时间就变成了一个高度经验化的事情。

- 系统高度定制化

  维护成本高。

Kafka 消息引擎系统就是为了解决这些问题，旨在提供三个方面的特性：

- 提供一套 API 实现生产者和消费者；
- 降低网络传输和磁盘存储开销；
- 实现高伸缩性架构。

**Kafka 只是消息引擎吗？**

Apache Kafka 是消息引擎系统，也是一个分布式流处理平台（Distributed Streaming Platform）。

Kafka 在承接上下游、串联数据流管道方面发挥了重要的作用：所有的数据几乎都要从一个系统流入 Kafka 然后再流向下游的另一个系统中。

这样的使用方式屡见不鲜以至于引发了 Kafka 社区的思考：与其我把数据从一个系统传递到下一个系统中做处理，我为何不自己实现一套流处理框架呢？基于这个考量，Kafka 社区于 0.10.0.0 版本正式推出了流处理组件 Kafka Streams，也正是从这个版本开始，Kafka 正式“变身”为分布式的流处理平台，而不仅仅是消息引擎系统了。

**Kafka Streams 流处理平台的优势在哪里？**

- 第一点是更容易实现端到端的正确性（Correctness）

  实现正确性是流处理能够匹敌批处理的基石。正确性一直是批处理的强项，而实现正确性则要求框架能提供精确一次处理语义，即处理一条消息有且只有一次机会能够影响系统状态。

- 第二点是 Kafka 对于流式计算的定位

  官网上明确标识 Kafka Streams 是一个用于搭建实时流处理的客户端库而非是一个完整的功能系统。这就是说，你不能期望着 Kafka 提供类似于集群调度、弹性部署等开箱即用的运维特性，你需要自己选择适合的工具或系统来帮助 Kafka 流处理应用实现这些功能。

  > 大型公司的流处理平台一定是大规模部署的，因此具备集群调度功能以及灵活的部署方案是不可或缺的要素。但毕竟这世界上还存在着很多中小企业，它们的流处理数据量并不巨大，逻辑也并不复杂，部署几台或十几台机器足以应付。在这样的需求之下，搭建重量级的完整性平台实在是“杀鸡焉用牛刀”，而这正是 Kafka 流处理组件的用武之地。因此从这个角度来说，未来在流处理框架中，Kafka 应该是有一席之地的。

**Kafka 分布式存储**

Kafka 作者之一 Jay Kreps 曾经专门写过一篇文章阐述为什么能把[Kafka 用作分布式存储](https://www.confluent.io/blog/okay-store-data-apache-kafka/)。不过目前还少有人这么用。

